{% extends 'base.html' %}

{% load static %}

{% block title %}Library{% endblock %}

{% block content %}
<h1 class="text-2xl font-bold mb-4">Your Chat App Configurations</h1>

<!-- Include the notification template -->
{% include 'notification.html' %}

<!-- Modal -->
<div class="modal fade" id="genericModal" tabindex="-1" aria-labelledby="genericModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="genericModalLabel">Confirm Action</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <p id="genericModalMessage"></p>
        <p class="font-bold text-lg" id="genericModalFileName"></p>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <button type="button" class="btn btn-primary" id="genericModalConfirmButton">Confirm</button>
      </div>
    </div>
  </div>
</div>

<ul id="file-list" class="space-y-4">
    {% for file in files %}
        <li id="deployment-{{ file.id }}" class="border rounded-lg p-4 shadow-lg bg-white">
            <div class="flex justify-between items-center">
                <div>
                    <p class="font-semibold">{{ file.file_name }}</p>
                    <p class="text-sm text-green-600 mt-2 deployed-text {% if file.has_deployment %}block{% else %}hidden{% endif %}">
                        This configuration is currently deployed.
                    </p>
                </div>
                <div class="flex space-x-2">
                    <button class="btn btn-danger btn-sm delete-file" data-file-id="{{ file.id }}" data-file-name="{{ file.file_name }}">Delete</button>
                    <button class="btn btn-primary btn-sm deploy-button {% if file.has_deployment %}opacity-50 cursor-not-allowed{% endif %}" 
                            data-file-id="{{ file.id }}" 
                            data-file-name="{{ file.file_name }}" 
                            {% if file.has_deployment %}disabled{% endif %}>
                        Deploy
                    </button>
                    <button class="btn btn-secondary btn-sm deployment-loading-button" data-file-id="{{ file.id }}" style="display: none;">
                        <span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Deploying...
                    </button>
                </div>
            </div>
        </li>
    {% empty %}
        <li class="text-gray-500">No files uploaded.</li>
    {% endfor %}
</ul>
{% endblock %}

{% block extra_scripts %}
<script src="{% static 'js/statusCheck.js' %}"></script>
<script>
  document.getElementById('uploadForm').addEventListener('submit', function(e) {
      e.preventDefault();  // Prevent the form from submitting normally
  
      const formData = new FormData(this);
      fetch('', {
          method: 'POST',
          body: formData,
          headers: {
              'X-CSRFToken': '{{ csrf_token }}',
          },
      })
      .then(response => {
          if (!response.ok) {
              // If response is not ok, try parsing error message
              return response.text().then(text => { throw new Error(text); });
          }
          return response.json();
      })
      .then(data => {
          if (data.retry && data.file_name) {
              // Show the file exists modal if the file already exists
              const fileName = data.file_name;
              const fileExtension = fileName.substring(fileName.lastIndexOf('.')); // Extract file extension
              const baseName = fileName.substring(0, fileName.lastIndexOf('.')); // Extract base name
  
              document.getElementById('fileExistsFileName').textContent = fileName;
              document.getElementById('newFileName').value = baseName; // Prefill the input with the base name
              document.getElementById('fileExtension').textContent = fileExtension; // Show the extension
  
              const fileExistsModal = new bootstrap.Modal(document.getElementById('fileExistsModal'));
              fileExistsModal.show();
          } else if (data.retry && data.chat_configuration_name) {
              // Show chatbot name taken feedback
              document.getElementById('chatbotNameTakenFeedback').style.display = 'block';
              const chatbotNameModal = new bootstrap.Modal(document.getElementById('chatbotNameModal'));
              chatbotNameModal.show();
          } else {
              // Redirect if the file was uploaded successfully
              window.location.href = '/account/library/';
          }
      })
      .catch(error => {
          console.error('Error:', error);
          alert('An error occurred: ' + error.message);  // Display error message
      });
  });
  
  // Handle the rename button click in the file exists modal
  document.getElementById('renameFileButton').addEventListener('click', function() {
      // Hide the file exists modal and show the rename modal
      const fileExistsModal = bootstrap.Modal.getInstance(document.getElementById('fileExistsModal'));
      fileExistsModal.hide();
      const renameModal = new bootstrap.Modal(document.getElementById('renameModal'));
      renameModal.show();
  });
  
  // Handle the confirm rename button click in the rename modal
  document.getElementById('confirmRenameButton').addEventListener('click', function() {
      const newFileNameInput = document.getElementById('newFileName');
      const newFileName = newFileNameInput.value.trim();
      const fileExtension = document.getElementById('fileExtension').textContent;
  
      // Validate the file name to ensure it doesn't contain invalid characters
      const isValidFileName = /^[a-zA-Z0-9_-]+$/.test(newFileName);
  
      if (isValidFileName) {
          // Add the new file name to the form data
          const formData = new FormData(document.getElementById('uploadForm'));
          formData.set('new_file_name', newFileName + fileExtension);  // Ensure the field is set
  
          fetch('', {
              method: 'POST',
              body: formData,
              headers: {
                  'X-CSRFToken': '{{ csrf_token }}',
              },
          })
          .then(response => {
              if (!response.ok) {
                  return response.text().then(text => { throw new Error(text); });
              }
              return response.json();
          })
          .then(data => {
              if (!data.retry) {
                  // Show chatbot naming modal after file rename
                  const renameModal = bootstrap.Modal.getInstance(document.getElementById('renameModal'));
                  renameModal.hide();
  
                  const chatbotNameModal = new bootstrap.Modal(document.getElementById('chatbotNameModal'));
                  chatbotNameModal.show();
              }
          })
          .catch(error => {
              console.error('Error:', error);
              alert('An error occurred: ' + error.message);
          });
      } else {
          // Show invalid feedback
          newFileNameInput.classList.add('is-invalid');
          document.getElementById('invalidFeedback').style.display = 'block';
      }
  });
  
  // Remove invalid class and hide feedback on input change
  document.getElementById('newFileName').addEventListener('input', function() {
      if (this.classList.contains('is-invalid')) {
          this.classList.remove('is-invalid');
          document.getElementById('invalidFeedback').style.display = 'none';
      }
  });
  
  // Handle the Enter key in the rename modal
  document.getElementById('newFileName').addEventListener('keypress', function(e) {
      if (e.key === 'Enter') {
          e.preventDefault(); // Prevent the modal from closing
          document.getElementById('confirmRenameButton').click(); // Trigger the confirm button click
      }
  });
  
  // Handle the confirm chatbot name button click in the chatbot naming modal
  document.getElementById('confirmChatbotNameButton').addEventListener('click', function() {
      const chatbotNameInput = document.getElementById('chatbotName');
      const chatbotName = chatbotNameInput.value.trim();
  
      if (chatbotName.length > 0 && chatbotName.length < 64) {
          // Add the chatbot name to the form data
          const formData = new FormData(document.getElementById('uploadForm'));
          formData.set('chat_configuration_name', chatbotName);  // Ensure the field is set
  
          fetch('', {
              method: 'POST',
              body: formData,
              headers: {
                  'X-CSRFToken': '{{ csrf_token }}',
              },
          })
          .then(response => {
              if (!response.ok) {
                  return response.text().then(text => { throw new Error(text); });
              }
              return response.json();
          })
          .then(data => {
              if (!data.retry) {
                  // Redirect to the library page
                  window.location.href = '/account/library/';
              } else if (data.retry && data.chat_configuration_name) {
                  // Show chatbot name taken feedback
                  chatbotNameInput.classList.add('is-invalid');
                  document.getElementById('chatbotNameTakenFeedback').style.display = 'block';
              }
          })
          .catch(error => {
              console.error('Error:', error);
              alert('An error occurred: ' + error.message);
          });
      } else {
          // Show invalid feedback
          chatbotNameInput.classList.add('is-invalid');
          document.getElementById('chatbotNameFeedback').style.display = 'block';
      }
  });
  
  // Remove invalid class and hide feedback on chatbot name input change
  document.getElementById('chatbotName').addEventListener('input', function() {
      if (this.classList.contains('is-invalid')) {
          this.classList.remove('is-invalid');
          document.getElementById('chatbotNameFeedback').style.display = 'none';
          document.getElementById('chatbotNameTakenFeedback').style.display = 'none';
      }
  });
  
  // Handle the Enter key in the chatbot naming modal
  document.getElementById('chatbotName').addEventListener('keypress', function(e) {
      if (e.key === 'Enter') {
          e.preventDefault(); // Prevent the modal from closing
          document.getElementById('confirmChatbotNameButton').click(); // Trigger the confirm button click
      }
  });
  </script>
{% endblock %}