{% extends 'base.html' %}

{% block title %}Library{% endblock %}

{% block content %}
<h1>Your Uploaded Files</h1>
<ul id="file-list">
    {% for file in files %}
        <li id="file-{{ file.id }}">
            {{ file.file.name }}
            <button class="btn btn-danger btn-sm delete-file" data-file-id="{{ file.id }}">Delete</button>
            <button class="btn btn-primary btn-sm deploy-file" data-file-id="{{ file.id }}">Deploy</button>
        </li>
    {% empty %}
        <li>No files uploaded.</li>
    {% endfor %}
</ul>

<div id="deployment-status"></div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    document.getElementById('file-list').addEventListener('click', function(event) {
        if (event.target.classList.contains('delete-file')) {
            const fileId = event.target.getAttribute('data-file-id');
            handleDelete(fileId);
        }
        if (event.target.classList.contains('deploy-file')) {
            const fileId = event.target.getAttribute('data-file-id');
            handleDeploy(fileId);
        }
    });
});

function handleDelete(fileId) {
    if (confirm('Are you sure you want to delete this file?')) {
        const button = document.querySelector(`[data-file-id="${fileId}"]`);
        button.disabled = true;
        button.textContent = 'Deleting...';
        
        deleteFile(fileId)
            .then(success => {
                if (success) {
                    const listItem = document.getElementById(`file-${fileId}`);
                    listItem.remove();
                    if (document.getElementById('file-list').children.length === 0) {
                        document.getElementById('file-list').innerHTML = '<li>No files uploaded.</li>';
                    }
                } else {
                    alert('Failed to delete file');
                    button.disabled = false;
                    button.textContent = 'Delete';
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('An error occurred while deleting the file');
                button.disabled = false;
                button.textContent = 'Delete';
            });
    }
}

function handleDeploy(fileId) {
    if (confirm('Are you sure you want to deploy this chat app?')) {
        const button = document.querySelector(`[data-file-id="${fileId}"]`);
        button.disabled = true;
        button.textContent = 'Deploying...';

        fetch(`/deploy/${fileId}/`, {
            method: 'POST',
            headers: {
                'X-CSRFToken': '{{ csrf_token }}'
            }
        }).then(response => response.json())
          .then(data => {
              const taskId = data.task_id;
              checkDeploymentStatus(taskId);
          })
          .catch(error => {
              console.error('Error:', error);
              alert('An error occurred while deploying the chat app');
              button.disabled = false;
              button.textContent = 'Deploy';
          });
    }
}

function checkDeploymentStatus(taskId) {
    fetch(`/deployment_status/${taskId}/`)
        .then(response => response.json())
        .then(data => {
            if (data.status === 'pending') {
                document.getElementById('deployment-status').innerHTML = 'Deployment is in progress...';
                setTimeout(() => checkDeploymentStatus(taskId), 5000);
            } else if (data.status === 'completed') {
                document.getElementById('deployment-status').innerHTML = 'Deployment completed! Endpoint: ' + data.endpoint;
            } else {
                document.getElementById('deployment-status').innerHTML = 'Deployment failed: ' + data.error;
            }
        })
        .catch(error => {
            console.error('Error:', error);
            document.getElementById('deployment-status').innerHTML = 'An error occurred while checking deployment status';
        });
}

async function deleteFile(fileId) {
    try {
        const response = await fetch(`/delete-file/${fileId}/`, {
            method: 'POST',
            headers: {
                'X-CSRFToken': '{{ csrf_token }}'
            }
        });
        const data = await response.json();
        return data.success;
    } catch (error) {
        console.error('Error:', error);
        return false;
    }
}
</script>
{% endblock %}