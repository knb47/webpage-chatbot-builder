{% extends 'base.html' %}

{% block title %}Library{% endblock %}

{% block content %}
<h1>Your Uploaded Files</h1>
<ul id="file-list">
    {% for file in files %}
        <li id="file-{{ file.id }}">
            {{ file.file.name }}
            <button class="btn btn-danger btn-sm delete-file" data-file-id="{{ file.id }}">Delete</button>
        </li>
    {% empty %}
        <li>No files uploaded.</li>
    {% endfor %}
</ul>

<script>
document.addEventListener('DOMContentLoaded', function() {
    document.getElementById('file-list').addEventListener('click', function(event) {
        if (event.target.classList.contains('delete-file')) {
            const fileId = event.target.getAttribute('data-file-id');
            handleDelete(fileId);
        }
    });
});

function handleDelete(fileId) {
    if (confirm('Are you sure you want to delete this file?')) {
        const button = document.querySelector(`[data-file-id="${fileId}"]`);
        button.disabled = true;
        button.textContent = 'Deleting...';
        
        deleteFile(fileId)
            .then(success => {
                if (success) {
                    const listItem = document.getElementById(`file-${fileId}`);
                    listItem.remove();
                    if (document.getElementById('file-list').children.length === 0) {
                        document.getElementById('file-list').innerHTML = '<li>No files uploaded.</li>';
                    }
                } else {
                    alert('Failed to delete file');
                    button.disabled = false;
                    button.textContent = 'Delete';
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('An error occurred while deleting the file');
                button.disabled = false;
                button.textContent = 'Delete';
            });
    }
}

async function deleteFile(fileId) {
    try {
        const response = await fetch(`/delete-file/${fileId}/`, {
            method: 'POST',
            headers: {
                'X-CSRFToken': '{{ csrf_token }}'
            }
        });
        const data = await response.json();
        return data.success;
    } catch (error) {
        console.error('Error:', error);
        return false;
    }
}
</script>
{% endblock %}